%% Instrument library flow: runtime invocation -> LogUnit -> storage -> replay/eval
%% You can regenerate an image via a Mermaid CLI or VS Code Mermaid extension.
flowchart LR
    subgraph Runtime[Application Runtime]
        A[User Function Call] -->|wrapped by logCall / @LogMethod / @LogAll| B[Wrapper]
        B --> C{Execute?}
        C -->|call original fn| D[Original Function]
        D --> E[Return Value or Throw]
        C -->|skip during deterministic replay| E
    end

    subgraph Capture[Capture Phase]
        E --> F[Build LogUnit\n{id, label, args, this?, start/end, result|error}]
        F --> G[Safe Stringify + Redact]
        G --> H[Append to Session Stream]
    end

    subgraph Storage[Storage (JSONL / Memory)]
        H --> I[(items.jsonl)]
    end

    subgraph Replay[Replay / Evaluation]
        I --> J[Read LogUnits Sequentially]
        J --> K{Mode}
        K -->|Deterministic| L[Inject recorded result/error\n(no original execution)]
        K -->|Verify| M[Re-run original function\ncompare to recorded]
        L --> N[Emit Events / Metrics]
        M --> N
    end

    N --> O[Report / Diff / Metrics]

    classDef accent fill:#f6f9ff,stroke:#4682b4,stroke-width:1px;
    class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O accent;
